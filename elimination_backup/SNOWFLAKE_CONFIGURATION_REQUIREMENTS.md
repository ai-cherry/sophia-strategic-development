# 🏔️ **modern_stack CONFIGURATION REQUIREMENTS**
## Sophia AI Platform - Detailed Infrastructure Specifications

### **🎯 OVERVIEW**
This document provides comprehensive Modern Stack configuration requirements for the Sophia AI platform implementation, including database structure, security settings, and optimization parameters.

---

## **📊 DATABASE ARCHITECTURE**

### **1. Database Hierarchy**
```
SOPHIA_AI_PROD (Production Database)
├── KNOWLEDGE_BASE (Schema)
├── AI_MEMORY (Schema)
├── SALES_INTELLIGENCE (Schema)
├── CORTEX_MIGRATION (Schema)
├── BUSINESS_INTELLIGENCE (Schema)
├── MONITORING (Schema)
└── SYSTEM_LOGS (Schema)
```

### **2. Primary Schemas Structure**

#### **KNOWLEDGE_BASE Schema**
```sql
-- Knowledge Base Tables
CREATE TABLE KNOWLEDGE_BASE.KNOWLEDGE_ITEMS (
    KNOWLEDGE_ID VARCHAR(255) PRIMARY KEY,
    TITLE VARCHAR(500) NOT NULL,
    CONTENT TEXT NOT NULL,
    KNOWLEDGE_TYPE VARCHAR(100) NOT NULL,
    SOURCE VARCHAR(100) NOT NULL,
    STATUS VARCHAR(50) DEFAULT 'pending_review',

    -- Metadata
    TAGS ARRAY,
    CATEGORIES ARRAY,
    RELATED_ITEMS ARRAY,
    CONFIDENCE_SCORE FLOAT DEFAULT 0.8,
    RELEVANCE_SCORE FLOAT DEFAULT 0.8,

    -- Business Context
    BUSINESS_CONTEXT VARIANT,
    USAGE_SCENARIOS ARRAY,
    TARGET_AUDIENCE ARRAY,

    -- Teaching Data
    TEACHING_EXAMPLES VARIANT,
    VALIDATION_FEEDBACK VARIANT,
    USAGE_ANALYTICS VARIANT,

    -- Cortex Integration
    CORTEX_EMBEDDING VECTOR(FLOAT, 768),
    CORTEX_SUMMARY TEXT,
    CORTEX_SENTIMENT VARIANT,

    -- Audit Trail
    CREATED_BY VARCHAR(255),
    CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    UPDATED_BY VARCHAR(255),
    UPDATED_AT TIMESTAMP_NTZ,
    VERSION INTEGER DEFAULT 1
);

-- Teaching Sessions
CREATE TABLE KNOWLEDGE_BASE.TEACHING_SESSIONS (
    SESSION_ID VARCHAR(255) PRIMARY KEY,
    KNOWLEDGE_ID VARCHAR(255),
    TEACHER_ID VARCHAR(255),
    SESSION_TYPE VARCHAR(100),

    -- Session Content
    ORIGINAL_QUERY TEXT,
    ORIGINAL_RESPONSE TEXT,
    FEEDBACK TEXT,
    CORRECTED_RESPONSE TEXT,
    TEACHING_EXAMPLES VARIANT,

    -- Timing
    SESSION_START TIMESTAMP_NTZ,
    SESSION_END TIMESTAMP_NTZ,
    EFFECTIVENESS_SCORE FLOAT,

    -- Constraints
    FOREIGN KEY (KNOWLEDGE_ID) REFERENCES KNOWLEDGE_BASE.KNOWLEDGE_ITEMS(KNOWLEDGE_ID)
);

-- Knowledge Analytics
CREATE TABLE KNOWLEDGE_BASE.KNOWLEDGE_ANALYTICS (
    ANALYTICS_ID VARCHAR(255) PRIMARY KEY,
    KNOWLEDGE_ID VARCHAR(255),
    QUERY_TEXT TEXT,
    RESPONSE_TIME_MS INTEGER,
    RELEVANCE_SCORE FLOAT,
    USER_SATISFACTION_SCORE FLOAT,
    ACCESSED_AT TIMESTAMP_NTZ,
    USER_ID VARCHAR(255),

    FOREIGN KEY (KNOWLEDGE_ID) REFERENCES KNOWLEDGE_BASE.KNOWLEDGE_ITEMS(KNOWLEDGE_ID)
);
```

#### **AI_MEMORY Schema**
```sql
-- Enhanced AI Memory with Cortex Integration
CREATE TABLE AI_MEMORY.MEMORY_RECORDS (
    MEMORY_ID VARCHAR(255) PRIMARY KEY,
    CONTENT TEXT NOT NULL,
    CATEGORY VARCHAR(100) NOT NULL,
    IMPORTANCE_SCORE FLOAT DEFAULT 0.5,

    -- Embeddings
    OPENAI_EMBEDDING VECTOR(FLOAT, 1536),
    CORTEX_EMBEDDING VECTOR(FLOAT, 768),
    EMBEDDING_MODEL VARCHAR(100),

    -- Metadata
    TAGS ARRAY,
    METADATA VARIANT,
    BUSINESS_CONTEXT VARIANT,

    -- Memory Relationships
    RELATED_MEMORIES ARRAY,
    PARENT_MEMORY_ID VARCHAR(255),
    CHILD_MEMORIES ARRAY,

    -- Access Patterns
    ACCESS_COUNT INTEGER DEFAULT 0,
    LAST_ACCESSED TIMESTAMP_NTZ,
    ACCESS_PATTERN VARIANT,

    -- Quality Metrics
    RELEVANCE_SCORE FLOAT,
    QUALITY_SCORE FLOAT,
    VALIDATION_STATUS VARCHAR(50),

    -- Audit
    CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    UPDATED_AT TIMESTAMP_NTZ,
    CREATED_BY VARCHAR(255)
);

-- Memory Migration Tracking
CREATE TABLE AI_MEMORY.MIGRATION_RECORDS (
    MIGRATION_ID VARCHAR(255) PRIMARY KEY,
    MEMORY_ID VARCHAR(255),
    SOURCE_SYSTEM VARCHAR(100),
    MIGRATION_TYPE VARCHAR(100),

    -- Original Data
    ORIGINAL_EMBEDDING VECTOR(FLOAT, 1536),
    ORIGINAL_METADATA VARIANT,
    CONTENT_HASH VARCHAR(255),

    -- Migration Results
    CORTEX_EMBEDDING VECTOR(FLOAT, 768),
    CORTEX_METADATA VARIANT,
    SIMILARITY_SCORE FLOAT,

    -- Status Tracking
    MIGRATION_STATUS VARCHAR(50),
    MIGRATION_ATTEMPTS INTEGER DEFAULT 0,
    MIGRATION_ERRORS ARRAY,

    -- Timing
    MIGRATION_STARTED_AT TIMESTAMP_NTZ,
    MIGRATION_COMPLETED_AT TIMESTAMP_NTZ,

    FOREIGN KEY (MEMORY_ID) REFERENCES AI_MEMORY.MEMORY_RECORDS(MEMORY_ID)
);
```

#### **SALES_INTELLIGENCE Schema**
```sql
-- Sales Coaching Insights
CREATE TABLE SALES_INTELLIGENCE.COACHING_INSIGHTS (
    INSIGHT_ID VARCHAR(255) PRIMARY KEY,
    SALES_REP_ID VARCHAR(255) NOT NULL,
    COACHING_TYPE VARCHAR(100) NOT NULL,
    PRIORITY VARCHAR(50) NOT NULL,

    -- Coaching Content
    SITUATION TEXT,
    INSIGHT TEXT,
    RECOMMENDATION TEXT,
    ACTION_STEPS ARRAY,

    -- Context and Scoring
    CONTEXT_DATA VARIANT,
    CONFIDENCE_SCORE FLOAT,
    URGENCY_SCORE FLOAT,

    -- Slack Integration
    SLACK_MESSAGE TEXT,
    SLACK_THREAD_ID VARCHAR(255),
    SLACK_CHANNEL VARCHAR(255),

    -- Delivery Tracking
    DELIVERED_AT TIMESTAMP_NTZ,
    REP_RESPONSE TEXT,
    EFFECTIVENESS_SCORE FLOAT,

    -- Cortex Analysis
    CORTEX_SENTIMENT VARIANT,
    CORTEX_TOPICS ARRAY,
    CORTEX_SUMMARY TEXT,

    CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

-- Sales Performance Analytics
CREATE TABLE SALES_INTELLIGENCE.PERFORMANCE_ANALYTICS (
    ANALYTICS_ID VARCHAR(255) PRIMARY KEY,
    SALES_REP_ID VARCHAR(255),
    PERIOD_START DATE,
    PERIOD_END DATE,

    -- Performance Metrics
    CALLS_COMPLETED INTEGER,
    MEETINGS_SCHEDULED INTEGER,
    DEALS_CLOSED INTEGER,
    REVENUE_GENERATED DECIMAL(15,2),

    -- Coaching Metrics
    COACHING_SESSIONS INTEGER,
    IMPROVEMENT_SCORE FLOAT,
    ENGAGEMENT_RATE FLOAT,

    -- AI Analysis
    PERFORMANCE_TRENDS VARIANT,
    IMPROVEMENT_AREAS ARRAY,
    STRENGTHS ARRAY,

    CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);
```

#### **CORTEX_MIGRATION Schema**
```sql
-- Migration Batches
CREATE TABLE CORTEX_MIGRATION.MIGRATION_BATCHES (
    BATCH_ID VARCHAR(255) PRIMARY KEY,
    SOURCE_SYSTEM VARCHAR(100) NOT NULL,
    MIGRATION_TYPE VARCHAR(100) NOT NULL,

    -- Batch Metadata
    TOTAL_RECORDS INTEGER,
    BATCH_SIZE INTEGER,
    PRIORITY_LEVEL INTEGER,

    -- Processing Status
    STATUS VARCHAR(50) DEFAULT 'pending',
    PROCESSED_COUNT INTEGER DEFAULT 0,
    SUCCESS_COUNT INTEGER DEFAULT 0,
    ERROR_COUNT INTEGER DEFAULT 0,

    -- Quality Metrics
    AVERAGE_SIMILARITY FLOAT,
    VALIDATION_RATE FLOAT,

    -- Timing
    STARTED_AT TIMESTAMP_NTZ,
    COMPLETED_AT TIMESTAMP_NTZ,

    CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

-- Migration Quality Validation
CREATE TABLE CORTEX_MIGRATION.QUALITY_VALIDATION (
    VALIDATION_ID VARCHAR(255) PRIMARY KEY,
    BATCH_ID VARCHAR(255),
    VALIDATION_TYPE VARCHAR(100),

    -- Validation Results
    OVERALL_SCORE FLOAT,
    CONTENT_INTEGRITY_SCORE FLOAT,
    SIMILARITY_SCORE FLOAT,
    METADATA_CONSISTENCY_SCORE FLOAT,
    SEARCH_FUNCTIONALITY_SCORE FLOAT,

    -- Validation Details
    VALIDATION_PASSED BOOLEAN,
    RECOMMENDATIONS ARRAY,
    VALIDATION_ERRORS ARRAY,

    VALIDATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),

    FOREIGN KEY (BATCH_ID) REFERENCES CORTEX_MIGRATION.MIGRATION_BATCHES(BATCH_ID)
);
```

---

## **🔐 SECURITY CONFIGURATION**

### **1. Role-Based Access Control**
```sql
-- Create Roles
CREATE ROLE SOPHIA_AI_ADMIN;
CREATE ROLE SOPHIA_AI_DEVELOPER;
CREATE ROLE SOPHIA_AI_ANALYST;
CREATE ROLE SOPHIA_AI_SALES_REP;
CREATE ROLE SOPHIA_AI_READONLY;

-- Database Permissions
GRANT USAGE ON DATABASE SOPHIA_AI_PROD TO ROLE SOPHIA_AI_ADMIN;
GRANT ALL PRIVILEGES ON DATABASE SOPHIA_AI_PROD TO ROLE SOPHIA_AI_ADMIN;

GRANT USAGE ON DATABASE SOPHIA_AI_PROD TO ROLE SOPHIA_AI_DEVELOPER;
GRANT USAGE ON ALL SCHEMAS IN DATABASE SOPHIA_AI_PROD TO ROLE SOPHIA_AI_DEVELOPER;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN DATABASE SOPHIA_AI_PROD TO ROLE SOPHIA_AI_DEVELOPER;

-- Schema-Specific Permissions
GRANT USAGE ON SCHEMA KNOWLEDGE_BASE TO ROLE SOPHIA_AI_ANALYST;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA KNOWLEDGE_BASE TO ROLE SOPHIA_AI_ANALYST;

GRANT USAGE ON SCHEMA SALES_INTELLIGENCE TO ROLE SOPHIA_AI_SALES_REP;
GRANT SELECT ON ALL TABLES IN SCHEMA SALES_INTELLIGENCE TO ROLE SOPHIA_AI_SALES_REP;

-- Read-Only Access
GRANT USAGE ON DATABASE SOPHIA_AI_PROD TO ROLE SOPHIA_AI_READONLY;
GRANT USAGE ON ALL SCHEMAS IN DATABASE SOPHIA_AI_PROD TO ROLE SOPHIA_AI_READONLY;
GRANT SELECT ON ALL TABLES IN DATABASE SOPHIA_AI_PROD TO ROLE SOPHIA_AI_READONLY;
```

### **2. Row-Level Security**
```sql
-- Sales Rep Data Isolation
CREATE ROW ACCESS POLICY sales_rep_policy AS (
    SALES_REP_ID = CURRENT_USER() OR
    IS_ROLE_IN_SESSION('SOPHIA_AI_ADMIN') OR
    IS_ROLE_IN_SESSION('SOPHIA_AI_DEVELOPER')
);

-- Apply to Sales Intelligence Tables
ALTER TABLE SALES_INTELLIGENCE.COACHING_INSIGHTS
ADD ROW ACCESS POLICY sales_rep_policy ON (SALES_REP_ID);

ALTER TABLE SALES_INTELLIGENCE.PERFORMANCE_ANALYTICS
ADD ROW ACCESS POLICY sales_rep_policy ON (SALES_REP_ID);
```

### **3. Data Masking**
```sql
-- Sensitive Data Masking
CREATE MASKING POLICY sensitive_text_mask AS (VAL STRING)
RETURNS STRING ->
CASE
    WHEN IS_ROLE_IN_SESSION('SOPHIA_AI_ADMIN') THEN VAL
    WHEN IS_ROLE_IN_SESSION('SOPHIA_AI_DEVELOPER') THEN VAL
    ELSE '***MASKED***'
END;

-- Apply to Sensitive Columns
ALTER TABLE SALES_INTELLIGENCE.COACHING_INSIGHTS
MODIFY COLUMN REP_RESPONSE SET MASKING POLICY sensitive_text_mask;
```

---

## **⚡ PERFORMANCE OPTIMIZATION**

### **1. Warehouse Configuration**
```sql
-- Primary Warehouse for AI Operations
CREATE WAREHOUSE SOPHIA_AI_CORTEX_WH
WITH
    WAREHOUSE_SIZE = 'LARGE'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE
    MIN_CLUSTER_COUNT = 1
    MAX_CLUSTER_COUNT = 10
    SCALING_POLICY = 'STANDARD'
    RESOURCE_MONITOR = 'SOPHIA_AI_MONITOR';

-- Knowledge Base Warehouse
CREATE WAREHOUSE SOPHIA_AI_KB_WH
WITH
    WAREHOUSE_SIZE = 'MEDIUM'
    AUTO_SUSPEND = 300
    AUTO_RESUME = TRUE
    MIN_CLUSTER_COUNT = 1
    MAX_CLUSTER_COUNT = 5
    SCALING_POLICY = 'ECONOMY';

-- Analytics Warehouse
CREATE WAREHOUSE SOPHIA_AI_ANALYTICS_WH
WITH
    WAREHOUSE_SIZE = 'X-LARGE'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE
    MIN_CLUSTER_COUNT = 1
    MAX_CLUSTER_COUNT = 20
    SCALING_POLICY = 'STANDARD';
```

### **2. Clustering and Indexing**
```sql
-- Cluster Keys for Performance
ALTER TABLE KNOWLEDGE_BASE.KNOWLEDGE_ITEMS
CLUSTER BY (KNOWLEDGE_TYPE, CREATED_AT);

ALTER TABLE AI_MEMORY.MEMORY_RECORDS
CLUSTER BY (CATEGORY, IMPORTANCE_SCORE);

ALTER TABLE SALES_INTELLIGENCE.COACHING_INSIGHTS
CLUSTER BY (SALES_REP_ID, CREATED_AT);

-- Search Optimization
ALTER TABLE KNOWLEDGE_BASE.KNOWLEDGE_ITEMS
ADD SEARCH OPTIMIZATION ON EQUALITY(KNOWLEDGE_TYPE, SOURCE, STATUS);

ALTER TABLE AI_MEMORY.MEMORY_RECORDS
ADD SEARCH OPTIMIZATION ON EQUALITY(CATEGORY, CREATED_BY);

ALTER TABLE SALES_INTELLIGENCE.COACHING_INSIGHTS
ADD SEARCH OPTIMIZATION ON EQUALITY(SALES_REP_ID, COACHING_TYPE);
```

### **3. Automatic Clustering**
```sql
-- Enable Automatic Clustering
ALTER TABLE KNOWLEDGE_BASE.KNOWLEDGE_ITEMS
RESUME RECLUSTER;

ALTER TABLE AI_MEMORY.MEMORY_RECORDS
RESUME RECLUSTER;

ALTER TABLE SALES_INTELLIGENCE.COACHING_INSIGHTS
RESUME RECLUSTER;
```

---

## **🤖 CORTEX AI INTEGRATION**

### **1. Cortex Functions Setup**
```sql
-- Enable Cortex Functions
USE WAREHOUSE SOPHIA_AI_CORTEX_WH;

-- Test Cortex Availability
SELECT modern_stack.CORTEX.COMPLETE('llama2-7b-chat', 'Hello, how are you?');

-- Verify Embedding Models
SELECT modern_stack.CORTEX.EMBED_TEXT_768('e5-base-v2', 'Test embedding generation');
```

### **2. Cortex-Powered Procedures**
```sql
-- Knowledge Base Enhancement
CREATE OR REPLACE PROCEDURE KNOWLEDGE_BASE.ENHANCE_WITH_CORTEX(KNOWLEDGE_ID VARCHAR)
RETURNS STRING
LANGUAGE SQL
AS
$$
BEGIN
    UPDATE KNOWLEDGE_BASE.KNOWLEDGE_ITEMS
    SET
        CORTEX_EMBEDDING = modern_stack.CORTEX.EMBED_TEXT_768('e5-base-v2', CONTENT),
        CORTEX_SUMMARY = modern_stack.CORTEX.SUMMARIZE(CONTENT),
        CORTEX_SENTIMENT = modern_stack.CORTEX.SENTIMENT(CONTENT),
        UPDATED_AT = CURRENT_TIMESTAMP()
    WHERE KNOWLEDGE_ID = :KNOWLEDGE_ID;

    RETURN 'Knowledge item enhanced with Cortex AI';
END;
$$;

-- AI Memory Processing
CREATE OR REPLACE PROCEDURE AI_MEMORY.PROCESS_WITH_CORTEX(MEMORY_ID VARCHAR)
RETURNS STRING
LANGUAGE SQL
AS
$$
BEGIN
    UPDATE AI_MEMORY.MEMORY_RECORDS
    SET
        CORTEX_EMBEDDING = modern_stack.CORTEX.EMBED_TEXT_768('e5-base-v2', CONTENT),
        QUALITY_SCORE = CASE
            WHEN LENGTH(CONTENT) > 100 AND IMPORTANCE_SCORE > 0.7 THEN 0.9
            WHEN LENGTH(CONTENT) > 50 THEN 0.7
            ELSE 0.5
        END,
        UPDATED_AT = CURRENT_TIMESTAMP()
    WHERE MEMORY_ID = :MEMORY_ID;

    RETURN 'Memory processed with Cortex AI';
END;
$$;

-- Sales Coaching Analysis
CREATE OR REPLACE PROCEDURE SALES_INTELLIGENCE.ANALYZE_COACHING_EFFECTIVENESS()
RETURNS STRING
LANGUAGE SQL
AS
$$
BEGIN
    UPDATE SALES_INTELLIGENCE.COACHING_INSIGHTS
    SET
        CORTEX_SENTIMENT = modern_stack.CORTEX.SENTIMENT(COALESCE(REP_RESPONSE, RECOMMENDATION)),
        CORTEX_TOPICS = modern_stack.CORTEX.EXTRACT_TOPICS(COALESCE(REP_RESPONSE, RECOMMENDATION)),
        CORTEX_SUMMARY = modern_stack.CORTEX.SUMMARIZE(SITUATION || ' ' || INSIGHT || ' ' || RECOMMENDATION),
        EFFECTIVENESS_SCORE = CASE
            WHEN REP_RESPONSE IS NOT NULL AND modern_stack.CORTEX.SENTIMENT(REP_RESPONSE):sentiment = 'positive' THEN 0.9
            WHEN REP_RESPONSE IS NOT NULL THEN 0.7
            ELSE 0.5
        END
    WHERE CORTEX_SENTIMENT IS NULL;

    RETURN 'Coaching insights analyzed with Cortex AI';
END;
$$;
```

### **3. Cortex Search Configuration**
```sql
-- Create Cortex Search Services
CREATE OR REPLACE CORTEX SEARCH SERVICE KNOWLEDGE_BASE_SEARCH
ON CONTENT
WAREHOUSE = SOPHIA_AI_CORTEX_WH
TARGET_LAG = '1 hour'
AS (
    SELECT
        KNOWLEDGE_ID,
        TITLE,
        CONTENT,
        KNOWLEDGE_TYPE,
        TAGS,
        CATEGORIES
    FROM KNOWLEDGE_BASE.KNOWLEDGE_ITEMS
    WHERE STATUS = 'validated'
);

CREATE OR REPLACE CORTEX SEARCH SERVICE AI_MEMORY_SEARCH
ON CONTENT
WAREHOUSE = SOPHIA_AI_CORTEX_WH
TARGET_LAG = '30 minutes'
AS (
    SELECT
        MEMORY_ID,
        CONTENT,
        CATEGORY,
        TAGS,
        IMPORTANCE_SCORE
    FROM AI_MEMORY.MEMORY_RECORDS
    WHERE VALIDATION_STATUS = 'approved'
);
```

---

## **📈 MONITORING AND ANALYTICS**

### **1. Resource Monitoring**
```sql
-- Create Resource Monitor
CREATE RESOURCE MONITOR SOPHIA_AI_MONITOR
WITH
    CREDIT_QUOTA = 1000
    FREQUENCY = 'DAILY'
    START_TIMESTAMP = CURRENT_TIMESTAMP()
    TRIGGERS
        ON 80 PERCENT DO NOTIFY
        ON 90 PERCENT DO SUSPEND
        ON 100 PERCENT DO SUSPEND_IMMEDIATE;

-- Apply to Warehouses
ALTER WAREHOUSE SOPHIA_AI_CORTEX_WH SET RESOURCE_MONITOR = 'SOPHIA_AI_MONITOR';
ALTER WAREHOUSE SOPHIA_AI_KB_WH SET RESOURCE_MONITOR = 'SOPHIA_AI_MONITOR';
ALTER WAREHOUSE SOPHIA_AI_ANALYTICS_WH SET RESOURCE_MONITOR = 'SOPHIA_AI_MONITOR';
```

### **2. Usage Analytics Views**
```sql
-- Cortex Usage Analytics
CREATE OR REPLACE VIEW MONITORING.CORTEX_USAGE_ANALYTICS AS
SELECT
    DATE_TRUNC('hour', CREATED_AT) as USAGE_HOUR,
    COUNT(*) as TOTAL_REQUESTS,
    COUNT(CASE WHEN CORTEX_EMBEDDING IS NOT NULL THEN 1 END) as SUCCESSFUL_EMBEDDINGS,
    COUNT(CASE WHEN CORTEX_SUMMARY IS NOT NULL THEN 1 END) as SUCCESSFUL_SUMMARIES,
    COUNT(CASE WHEN CORTEX_SENTIMENT IS NOT NULL THEN 1 END) as SUCCESSFUL_SENTIMENTS,
    AVG(ARRAY_SIZE(CORTEX_EMBEDDING)) as AVG_EMBEDDING_DIMENSIONS
FROM KNOWLEDGE_BASE.KNOWLEDGE_ITEMS
WHERE CREATED_AT >= CURRENT_DATE - 7
GROUP BY DATE_TRUNC('hour', CREATED_AT)
ORDER BY USAGE_HOUR DESC;

-- Performance Metrics
CREATE OR REPLACE VIEW MONITORING.PERFORMANCE_METRICS AS
SELECT
    'Knowledge Base' as SERVICE,
    COUNT(*) as TOTAL_RECORDS,
    AVG(CONFIDENCE_SCORE) as AVG_CONFIDENCE,
    AVG(RELEVANCE_SCORE) as AVG_RELEVANCE,
    COUNT(CASE WHEN STATUS = 'validated' THEN 1 END) as VALIDATED_RECORDS
FROM KNOWLEDGE_BASE.KNOWLEDGE_ITEMS
UNION ALL
SELECT
    'AI Memory' as SERVICE,
    COUNT(*) as TOTAL_RECORDS,
    AVG(IMPORTANCE_SCORE) as AVG_CONFIDENCE,
    AVG(QUALITY_SCORE) as AVG_RELEVANCE,
    COUNT(CASE WHEN VALIDATION_STATUS = 'approved' THEN 1 END) as VALIDATED_RECORDS
FROM AI_MEMORY.MEMORY_RECORDS
UNION ALL
SELECT
    'Sales Intelligence' as SERVICE,
    COUNT(*) as TOTAL_RECORDS,
    AVG(CONFIDENCE_SCORE) as AVG_CONFIDENCE,
    AVG(EFFECTIVENESS_SCORE) as AVG_RELEVANCE,
    COUNT(CASE WHEN EFFECTIVENESS_SCORE > 0.8 THEN 1 END) as VALIDATED_RECORDS
FROM SALES_INTELLIGENCE.COACHING_INSIGHTS;
```

### **3. Automated Maintenance Tasks**
```sql
-- Scheduled Tasks for Maintenance
CREATE OR REPLACE TASK KNOWLEDGE_BASE.AUTO_CORTEX_ENHANCEMENT
WAREHOUSE = SOPHIA_AI_CORTEX_WH
SCHEDULE = '10 MINUTE'
AS
CALL KNOWLEDGE_BASE.ENHANCE_WITH_CORTEX(
    (SELECT KNOWLEDGE_ID FROM KNOWLEDGE_BASE.KNOWLEDGE_ITEMS
     WHERE CORTEX_EMBEDDING IS NULL LIMIT 1)
);

CREATE OR REPLACE TASK AI_MEMORY.AUTO_MEMORY_PROCESSING
WAREHOUSE = SOPHIA_AI_CORTEX_WH
SCHEDULE = '5 MINUTE'
AS
CALL AI_MEMORY.PROCESS_WITH_CORTEX(
    (SELECT MEMORY_ID FROM AI_MEMORY.MEMORY_RECORDS
     WHERE CORTEX_EMBEDDING IS NULL LIMIT 1)
);

CREATE OR REPLACE TASK SALES_INTELLIGENCE.AUTO_COACHING_ANALYSIS
WAREHOUSE = SOPHIA_AI_CORTEX_WH
SCHEDULE = '30 MINUTE'
AS
CALL SALES_INTELLIGENCE.ANALYZE_COACHING_EFFECTIVENESS();

-- Start Tasks
ALTER TASK KNOWLEDGE_BASE.AUTO_CORTEX_ENHANCEMENT RESUME;
ALTER TASK AI_MEMORY.AUTO_MEMORY_PROCESSING RESUME;
ALTER TASK SALES_INTELLIGENCE.AUTO_COACHING_ANALYSIS RESUME;
```

---

## **🔄 DATA PIPELINE INTEGRATION**

### **1. External Stages**
```sql
-- Create External Stages for Data Ingestion
CREATE OR REPLACE STAGE SOPHIA_AI_KNOWLEDGE_STAGE
URL = 's3://sophia-ai-knowledge-bucket/'
CREDENTIALS = (AWS_KEY_ID = 'your_key' AWS_SECRET_KEY = 'your_secret')
FILE_FORMAT = (
    TYPE = JSON
    COMPRESSION = AUTO
    ENABLE_OCTAL = FALSE
    ALLOW_DUPLICATE = FALSE
    STRIP_OUTER_ARRAY = TRUE
    STRIP_NULL_VALUES = TRUE
);

CREATE OR REPLACE STAGE SOPHIA_AI_MEMORY_STAGE
URL = 's3://sophia-ai-memory-bucket/'
CREDENTIALS = (AWS_KEY_ID = 'your_key' AWS_SECRET_KEY = 'your_secret')
FILE_FORMAT = (
    TYPE = PARQUET
    COMPRESSION = SNAPPY
);
```

### **2. Data Loading Procedures**
```sql
-- Knowledge Base Data Loading
CREATE OR REPLACE PROCEDURE KNOWLEDGE_BASE.LOAD_KNOWLEDGE_DATA()
RETURNS STRING
LANGUAGE SQL
AS
$$
BEGIN
    COPY INTO KNOWLEDGE_BASE.KNOWLEDGE_ITEMS_STAGING
    FROM @SOPHIA_AI_KNOWLEDGE_STAGE
    PATTERN = '.*knowledge_items.*\.json'
    FILE_FORMAT = (TYPE = JSON);

    MERGE INTO KNOWLEDGE_BASE.KNOWLEDGE_ITEMS KI
    USING KNOWLEDGE_BASE.KNOWLEDGE_ITEMS_STAGING KIS
    ON KI.KNOWLEDGE_ID = KIS.KNOWLEDGE_ID
    WHEN MATCHED THEN UPDATE SET
        CONTENT = KIS.CONTENT,
        UPDATED_AT = CURRENT_TIMESTAMP()
    WHEN NOT MATCHED THEN INSERT (
        KNOWLEDGE_ID, TITLE, CONTENT, KNOWLEDGE_TYPE, SOURCE, CREATED_AT
    ) VALUES (
        KIS.KNOWLEDGE_ID, KIS.TITLE, KIS.CONTENT, KIS.KNOWLEDGE_TYPE, KIS.SOURCE, CURRENT_TIMESTAMP()
    );

    RETURN 'Knowledge data loaded successfully';
END;
$$;
```

---

## **🎯 DEPLOYMENT CHECKLIST**

### **✅ Pre-Deployment Requirements**
1. **Account Setup**
   - [ ] Modern Stack account with Enterprise edition
   - [ ] Cortex AI enabled in account
   - [ ] Appropriate regional deployment (US, EU, etc.)

2. **Warehouses Configuration**
   - [ ] SOPHIA_AI_CORTEX_WH created and configured
   - [ ] SOPHIA_AI_KB_WH created and configured
   - [ ] SOPHIA_AI_ANALYTICS_WH created and configured
   - [ ] Resource monitors applied

3. **Database Structure**
   - [ ] SOPHIA_AI_PROD database created
   - [ ] All schemas created (KNOWLEDGE_BASE, AI_MEMORY, etc.)
   - [ ] All tables created with proper structure
   - [ ] Clustering keys applied

4. **Security Setup**
   - [ ] Roles created and configured
   - [ ] Permissions granted appropriately
   - [ ] Row-level security policies applied
   - [ ] Data masking policies configured

5. **Cortex Integration**
   - [ ] Cortex functions tested and working
   - [ ] Cortex search services created
   - [ ] Cortex-powered procedures deployed
   - [ ] Embedding models validated

6. **Performance Optimization**
   - [ ] Search optimization enabled
   - [ ] Automatic clustering configured
   - [ ] Monitoring views created
   - [ ] Automated tasks scheduled

### **🚀 Post-Deployment Validation**
1. **Functionality Testing**
   - [ ] Knowledge base ingestion working
   - [ ] AI memory storage and retrieval functional
   - [ ] Sales coaching insights generation operational
   - [ ] Cortex embeddings generating correctly

2. **Performance Validation**
   - [ ] Query response times < 200ms for knowledge retrieval
   - [ ] Embedding generation completing in < 5 seconds
   - [ ] Cortex search returning results in < 1 second
   - [ ] Warehouse auto-scaling functioning

3. **Security Validation**
   - [ ] Role-based access working correctly
   - [ ] Row-level security filtering properly
   - [ ] Data masking applied to sensitive columns
   - [ ] Audit logging capturing all activities

4. **Integration Testing**
   - [ ] External stage connections working
   - [ ] Data pipeline ingestion functional
   - [ ] API connections established
   - [ ] Monitoring alerts configured

---

## **📞 SUPPORT AND TROUBLESHOOTING**

### **Common Issues and Solutions**

#### **Cortex Function Errors**
```sql
-- Test Cortex availability
SELECT CURRENT_WAREHOUSE(), CURRENT_ACCOUNT();
SELECT modern_stack.CORTEX.COMPLETE('llama2-7b-chat', 'test');

-- If Cortex unavailable, check account features
SHOW FEATURES;
```

#### **Performance Issues**
```sql
-- Check warehouse utilization
SELECT * FROM modern_stack.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY
WHERE WAREHOUSE_NAME IN ('SOPHIA_AI_CORTEX_WH', 'SOPHIA_AI_KB_WH')
AND START_TIME >= CURRENT_DATE - 7;

-- Optimize clustering
ALTER WAREHOUSE SOPHIA_AI_CORTEX_WH SET WAREHOUSE_SIZE = 'X-LARGE';
```

#### **Memory Issues**
```sql
-- Monitor memory usage
SELECT * FROM modern_stack.ACCOUNT_USAGE.QUERY_HISTORY
WHERE QUERY_TEXT ILIKE '%CORTEX%'
AND EXECUTION_STATUS = 'FAILED'
ORDER BY START_TIME DESC;
```

### **Monitoring Queries**
```sql
-- Real-time system health
SELECT
    CURRENT_TIMESTAMP() as CHECK_TIME,
    COUNT(*) as ACTIVE_SESSIONS,
    SUM(CASE WHEN WAREHOUSE_NAME LIKE 'SOPHIA_AI%' THEN 1 ELSE 0 END) as SOPHIA_SESSIONS
FROM modern_stack.ACCOUNT_USAGE.SESSIONS
WHERE END_TIME IS NULL;

-- Daily usage summary
SELECT
    DATE(START_TIME) as USAGE_DATE,
    WAREHOUSE_NAME,
    SUM(CREDITS_USED) as DAILY_CREDITS,
    COUNT(*) as QUERY_COUNT
FROM modern_stack.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY
WHERE WAREHOUSE_NAME LIKE 'SOPHIA_AI%'
AND START_TIME >= CURRENT_DATE - 30
GROUP BY DATE(START_TIME), WAREHOUSE_NAME
ORDER BY USAGE_DATE DESC, WAREHOUSE_NAME;
```

---

## **🔗 INTEGRATION ENDPOINTS**

### **API Configuration**
```yaml
# Modern Stack Connection Parameters
modern_stack:
  account: "your-account.modern_stackcomputing.com"
  user: "SOPHIA_AI_SERVICE"
  role: "SOPHIA_AI_DEVELOPER"
  warehouse: "SOPHIA_AI_CORTEX_WH"
  database: "SOPHIA_AI_PROD"
  schema: "KNOWLEDGE_BASE"

# Cortex Service Configuration
cortex:
  embedding_model: "e5-base-v2"
  completion_model: "llama2-7b-chat"
  max_tokens: 2048
  temperature: 0.7

# Performance Settings
performance:
  query_timeout: 300
  max_retries: 3
  batch_size: 100
  connection_pool_size: 10
```

This comprehensive configuration provides the complete Modern Stack infrastructure needed for the Sophia AI platform implementation. All components are designed for enterprise-scale operation with proper security, performance optimization, and monitoring capabilities.
