name: ðŸ” Contamination Check
# Daily check for Weaviate contamination in codebase
# Ensures clean Qdrant-centric architecture

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
  pull_request:
    branches: [ main ]

jobs:
  contamination-check:
    name: ðŸ” Check for Weaviate Contamination
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check workflows for contamination
        run: |
          echo "ðŸ” Checking GitHub workflows for Weaviate references..."
          contamination_found=false
          
          # Check active workflows (not disabled ones)
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              # Skip if workflow is disabled
              if grep -q "if: false" "$workflow"; then
                echo "  â­ï¸ Skipping disabled workflow: $workflow"
                continue
              fi
              
              # Check for Weaviate references
              if grep -i "weaviate" "$workflow"; then
                echo "  âŒ Weaviate contamination found in: $workflow"
                contamination_found=true
              fi
            fi
          done
          
          if [ "$contamination_found" = true ]; then
            echo "âŒ Contamination detected - failing check"
            exit 1
          else
            echo "âœ… No contamination found in workflows"
          fi
      
      - name: Check K8s manifests for contamination
        run: |
          echo "ðŸ” Checking K8s manifests for Weaviate references..."
          contamination_found=false
          
          for manifest in k8s/**/*.yml k8s/**/*.yaml; do
            if [ -f "$manifest" ]; then
              if grep -i "weaviate" "$manifest"; then
                echo "  âŒ Weaviate contamination found in: $manifest"
                contamination_found=true
              fi
            fi
          done
          
          if [ "$contamination_found" = true ]; then
            echo "âŒ Contamination detected in K8s manifests"
            exit 1
          else
            echo "âœ… No contamination found in K8s manifests"
          fi
      
      - name: Check Docker Compose for contamination
        run: |
          echo "ðŸ” Checking Docker Compose files for Weaviate references..."
          contamination_found=false
          
          for compose in docker-compose*.yml docker-compose*.yaml; do
            if [ -f "$compose" ]; then
              if grep -i "weaviate" "$compose"; then
                echo "  âŒ Weaviate contamination found in: $compose"
                contamination_found=true
              fi
            fi
          done
          
          if [ "$contamination_found" = true ]; then
            echo "âŒ Contamination detected in Docker Compose files"
            exit 1
          else
            echo "âœ… No contamination found in Docker Compose files"
          fi
      
      - name: Generate contamination report
        if: always()
        run: |
          echo "ðŸ“Š Generating contamination report..."
          echo "Date: $(date)" > contamination_report.txt
          echo "Status: ${{ job.status }}" >> contamination_report.txt
          echo "Repository: ${{ github.repository }}" >> contamination_report.txt
          echo "Commit: ${{ github.sha }}" >> contamination_report.txt
          
          echo "ðŸ“Š Contamination check completed"
      
      - name: Upload contamination report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: contamination-report
          path: contamination_report.txt
