name: 🔍 Contamination Check
# Daily check for Qdrant contamination in codebase
# Ensures clean Qdrant-centric architecture

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
  pull_request:
    branches: [ main ]

jobs:
  contamination-check:
    name: 🔍 Check for Qdrant Contamination
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check workflows for contamination
        run: |
          echo "🔍 Checking GitHub workflows for Qdrant references..."
          contamination_found=false
          
          # Check active workflows (not disabled ones)
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              # Skip if workflow is disabled
              if grep -q "if: false" "$workflow"; then
                echo "  ⏭️ Skipping disabled workflow: $workflow"
                continue
              fi
              
              # Check for Qdrant references
              if grep -i "qdrant" "$workflow"; then
                echo "  ❌ Qdrant contamination found in: $workflow"
                contamination_found=true
              fi
            fi
          done
          
          if [ "$contamination_found" = true ]; then
            echo "❌ Contamination detected - failing check"
            exit 1
          else
            echo "✅ No contamination found in workflows"
          fi
      
      - name: Check K8s manifests for contamination
        run: |
          echo "🔍 Checking K8s manifests for Qdrant references..."
          contamination_found=false
          
          for manifest in k8s/**/*.yml k8s/**/*.yaml; do
            if [ -f "$manifest" ]; then
              if grep -i "qdrant" "$manifest"; then
                echo "  ❌ Qdrant contamination found in: $manifest"
                contamination_found=true
              fi
            fi
          done
          
          if [ "$contamination_found" = true ]; then
            echo "❌ Contamination detected in K8s manifests"
            exit 1
          else
            echo "✅ No contamination found in K8s manifests"
          fi
      
      - name: Check Docker Compose for contamination
        run: |
          echo "🔍 Checking Docker Compose files for Qdrant references..."
          contamination_found=false
          
          for compose in docker-compose*.yml docker-compose*.yaml; do
            if [ -f "$compose" ]; then
              if grep -i "qdrant" "$compose"; then
                echo "  ❌ Qdrant contamination found in: $compose"
                contamination_found=true
              fi
            fi
          done
          
          if [ "$contamination_found" = true ]; then
            echo "❌ Contamination detected in Docker Compose files"
            exit 1
          else
            echo "✅ No contamination found in Docker Compose files"
          fi
      
      - name: Generate contamination report
        if: always()
        run: |
          echo "📊 Generating contamination report..."
          echo "Date: $(date)" > contamination_report.txt
          echo "Status: ${{ job.status }}" >> contamination_report.txt
          echo "Repository: ${{ github.repository }}" >> contamination_report.txt
          echo "Commit: ${{ github.sha }}" >> contamination_report.txt
          
          echo "📊 Contamination check completed"
      
      - name: Upload contamination report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: contamination-report
          path: contamination_report.txt
