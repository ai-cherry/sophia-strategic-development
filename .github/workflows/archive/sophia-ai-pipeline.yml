name: Sophia AI CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  modern_stack_ACCOUNT: ${{ secrets.modern_stack_ACCOUNT }}
  modern_stack_USER: ${{ secrets.modern_stack_USER }}
  modern_stack_PASSWORD: ${{ secrets.modern_stack_PASSWORD }}

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Run tests
        run: |
          uv run pytest tests/ -v --cov=backend --cov-report=xml

      - name: Run security scan
        run: |
          uv run bandit -r backend/ -f json -o bandit-report.json

      - name: Upload to Codacy
        run: |
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r coverage.xml

  deploy:
    needs: quality
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Lambda Labs
        run: |
          python scripts/deploy_to_lambda.py

      - name: Update modern_stack
        run: |
          python scripts/update_modern_stack_schemas.py

      - name: Sync MCP Servers
        run: |
          python scripts/sync_mcp_servers.py
