name: 🏥 Repository Health Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  health-check:
    name: 🏥 Repository Health Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install requests aiohttp

      - name: Run health analysis
        run: python scripts/github_alignment_optimizer.py

      - name: Upload health report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: health-report-${{ github.run_number }}
          path: github_alignment_report.json

      - name: Alert on critical issues
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST "$SLACK_WEBHOOK" \
              -H 'Content-type: application/json' \
              --data '{
                "text": "🚨 Sophia AI Repository Health Check Failed!",
                "attachments": [{
                  "color": "danger",
                  "fields": [{
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  }, {
                    "title": "Run ID",
                    "value": "${{ github.run_id }}",
                    "short": true
                  }, {
                    "title": "Triggered By",
                    "value": "${{ github.actor }}",
                    "short": true
                  }]
                }]
              }'
          else
            echo "⚠️ SLACK_WEBHOOK not configured - skipping notification"
          fi

  validate-workflows:
    name: 🔍 Validate Workflow Health
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check workflow syntax
        run: |
          echo "🔍 Validating workflow syntax..."
          for workflow in .github/workflows/*.yml; do
            echo "Checking $workflow..."
            if ! python -c "import yaml; yaml.safe_load(open('$workflow'))" 2>/dev/null; then
              echo "❌ Syntax error in $workflow"
              exit 1
            else
              echo "✅ $workflow syntax is valid"
            fi
          done

      - name: Check for workflow conflicts
        run: |
          echo "🔍 Checking for workflow trigger conflicts..."

          # Check for multiple workflows with same trigger patterns
          main_triggers=$(grep -l "branches.*main" .github/workflows/*.yml | wc -l)
          echo "Workflows triggering on main branch: $main_triggers"

          if [ "$main_triggers" -gt 2 ]; then
            echo "⚠️ Multiple workflows trigger on main branch - potential conflicts"
            grep -l "branches.*main" .github/workflows/*.yml
          else
            echo "✅ Workflow triggers appear well-coordinated"
          fi

  performance-check:
    name: 📊 Performance Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Analyze recent workflow performance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "📊 Analyzing recent workflow performance..."

          # Get recent workflow runs
          curl -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=50" \
               > workflow_runs.json

          # Calculate failure rate
          total_runs=$(jq '.workflow_runs | length' workflow_runs.json)
          failed_runs=$(jq '[.workflow_runs[] | select(.conclusion == "failure")] | length' workflow_runs.json)

          if [ "$total_runs" -gt 0 ]; then
            failure_rate=$(( failed_runs * 100 / total_runs ))
            echo "📈 Failure rate: $failure_rate% ($failed_runs/$total_runs)"

            if [ "$failure_rate" -gt 50 ]; then
              echo "🚨 HIGH FAILURE RATE DETECTED: $failure_rate%"
              echo "FAILURE_RATE_HIGH=true" >> $GITHUB_ENV
            else
              echo "✅ Failure rate within acceptable range"
            fi
          else
            echo "ℹ️ No recent workflow runs found"
          fi

      - name: Alert on high failure rate
        if: env.FAILURE_RATE_HIGH == 'true'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST "$SLACK_WEBHOOK" \
              -H 'Content-type: application/json' \
              --data '{
                "text": "🚨 High Workflow Failure Rate Detected!",
                "attachments": [{
                  "color": "warning",
                  "text": "Sophia AI repository has >50% workflow failure rate. Immediate investigation required.",
                  "fields": [{
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  }, {
                    "title": "Action Required",
                    "value": "Review recent workflow failures and fix issues",
                    "short": false
                  }]
                }]
              }'
          fi
