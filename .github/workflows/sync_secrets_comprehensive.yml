name: Sync ALL GitHub Secrets to Pulumi ESC

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  push:
    branches: [ main ]
    paths:
      - 'scripts/map_all_github_secrets_to_pulumi.py'
      - '.github/workflows/sync_secrets_comprehensive.yml'

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Pulumi CLI
      uses: pulumi/actions@v4
      with:
        pulumi-version: latest
        
    - name: Configure Pulumi
      run: |
        pulumi login
        pulumi org set-default scoobyjava-org
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        
    - name: Sync ALL GitHub Secrets to Pulumi ESC
      run: |
        echo "🚀 Syncing ALL GitHub Secrets to Pulumi ESC"
        
        # AI Services
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret anthropic_api_key "${{ secrets.ANTHROPIC_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret openai_api_key "${{ secrets.OPENAI_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret pinecone_api_key "${{ secrets.PINECONE_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret deepseek_api_key "${{ secrets.DEEPSEEK_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret groq_api_key "${{ secrets.GROQ_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret mistral_api_key "${{ secrets.MISTRAL_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret perplexity_api_key "${{ secrets.PERPLEXITY_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret together_ai_api_key "${{ secrets.TOGETHER_AI_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret langchain_api_key "${{ secrets.LANGCHAIN_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret langgraph_api_key "${{ secrets.LANGGRAPH_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret langsmith_api_key "${{ secrets.LANGSMITH_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret cohere_api_key "${{ secrets.COHERE_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret eleven_labs_api_key "${{ secrets.ELEVEN_LABS_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret stability_api_key "${{ secrets.STABILITY_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret huggingface_api_token "${{ secrets.HUGGINGFACE_API_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret portkey_api_key "${{ secrets.PORTKEY_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret openrouter_api_key "${{ secrets.OPENROUTER_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret mem0_api_key "${{ secrets.MEM0_API_KEY }}"
        
        # Docker
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret docker_token "${{ secrets.DOCKER_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret docker_username "${{ secrets.DOCKERHUB_USERNAME }}"
        
        # Snowflake
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_account "${{ secrets.SNOWFLAKE_ACCOUNT }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_user "${{ secrets.SNOWFLAKE_USER }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_password "${{ secrets.SNOWFLAKE_PASSWORD }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_warehouse "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_database "${{ secrets.SNOWFLAKE_DATABASE }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_schema "${{ secrets.SNOWFLAKE_SCHEMA }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_role "${{ secrets.SNOWFLAKE_ROLE }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_pat "${{ secrets.SNOWFLAKE_PAT }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret snowflake_connection_url "${{ secrets.SNOWFLAKE_CONNECTION_URL }}"
        
        # Lambda Labs
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret lambda_labs_api_key "${{ secrets.LAMBDA_LABS_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret lambda_api_cloud_endpoint "${{ secrets.LAMBDA_API_CLOUD_ENDPOINT }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret lambda_cloud_api_key "${{ secrets.LAMBDA_CLOUD_API_KEY }}"
        
        # GitHub
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret github_token "${{ secrets.GH_API_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret github_classic_pat_token "${{ secrets.GH_CLASSIC_PAT_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret github_fine_grained_token "${{ secrets.GH_FINE_GRAINED_TOKEN }}"
        
        # Business Tools
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret linear_api_key "${{ secrets.LINEAR_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret notion_api_key "${{ secrets.NOTION_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret notion_api_token "${{ secrets.NOTION_API_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret asana_api_token "${{ secrets.ASANA_API_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret figma_pat "${{ secrets.FIGMA_PAT }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret figma_project_id "${{ secrets.FIGMA_PROJECT_ID }}"
        
        # CRM & Sales
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret hubspot_api_key "${{ secrets.HUBSPOT_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret hubspot_access_token "${{ secrets.HUBSPOT_ACCESS_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret hubspot_client_secret "${{ secrets.HUBSPOT_CLIENT_SECRET }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret gong_access_key "${{ secrets.GONG_ACCESS_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret gong_access_key_secret "${{ secrets.GONG_ACCESS_KEY_SECRET }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret gong_client_secret "${{ secrets.GONG_CLIENT_SECRET }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret gong_base_url "${{ secrets.GONG_BASE_URL }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret salesforce_access_token "${{ secrets.SALESFORCE_ACCESS_TOKEN }}"
        
        # Communication
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret slack_bot_token "${{ secrets.SLACK_BOT_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret slack_app_token "${{ secrets.SLACK_APP_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret slack_client_id "${{ secrets.SLACK_CLIENT_ID }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret slack_client_secret "${{ secrets.SLACK_CLIENT_SECRET }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret slack_signing_secret "${{ secrets.SLACK_SIGNING_SECRET }}"
        
        # Infrastructure
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret pulumi_access_token "${{ secrets.PULUMI_ACCESS_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret database_url "${{ secrets.DATABASE_URL }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret redis_password "${{ secrets.REDIS_PASSWORD }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret redis_url "${{ secrets.REDIS_URL }}"
        
        # Deployment
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret vercel_access_token "${{ secrets.VERCEL_ACCESS_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret vercel_org_id "${{ secrets.VERCEL_ORG_ID }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret vercel_project_id_sophia_prod "${{ secrets.VERCEL_PROJECT_ID_SOPHIA_PROD }}"
        
        # Monitoring
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret grafana_url "${{ secrets.GRAFANA_URL }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret grafana_username "${{ secrets.GRAFANA_USERNAME }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret grafana_password "${{ secrets.GRAFANA_PASSWORD }}"
        
        # Data & Analytics
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret estuary_access_token "${{ secrets.ESTUARY_ACCESS_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret estuary_endpoint "${{ secrets.ESTUARY_ENDPOINT }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret estuary_refresh_token "${{ secrets.ESTUARY_REFRESH_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret estuary_tenant "${{ secrets.ESTUARY_TENANT }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret weaviate_api_key "${{ secrets.WEAVIATE_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret weaviate_url "${{ secrets.WEAVIATE_URL }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret weaviate_rest_endpoint "${{ secrets.WEAVIATE_REST_ENDPOINT }}"
        
        # Code Quality
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret codacy_api_token "${{ secrets.CODACY_API_TOKEN }}"
        
        # Development
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret npm_api_token "${{ secrets.NPM_API_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret jwt_secret "${{ secrets.JWT_SECRET }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret encryption_key "${{ secrets.ENCRYPTION_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret api_secret_key "${{ secrets.API_SECRET_KEY }}"
        
        # External APIs
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret serp_api_key "${{ secrets.SERP_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret tavily_api_key "${{ secrets.TAVILY_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret exa_api_key "${{ secrets.EXA_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret brave_api_key "${{ secrets.BRAVE_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret apify_api_token "${{ secrets.APIFY_API_TOKEN }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret apollo_api_key "${{ secrets.APOLLO_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret namecheap_api_key "${{ secrets.NAMECHEAP_API_KEY }}"
        pulumi env set scoobyjava-org/default/sophia-ai-production --secret namecheap_username "${{ secrets.NAMECHEAP_USERNAME }}"
        
        echo "✅ ALL SECRETS SYNCED TO PULUMI ESC!"
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        
    - name: Verify Sync
      run: |
        echo "🔍 Verifying secret sync..."
        pulumi env get scoobyjava-org/default/sophia-ai-production --json | jq 'keys | length' || echo "0"
        echo "✅ Sync verification complete"
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        
    - name: Test Docker Login
      run: |
        echo "🐳 Testing Docker login..."
        python3 -c "
        from backend.core.auto_esc_config import get_docker_hub_config
        config = get_docker_hub_config()
        print(f'Docker Username: {config[\"username\"]}')
        print(f'Docker Token: {\"*\" * (len(config[\"access_token\"]) - 4) + config[\"access_token\"][-4:] if config[\"access_token\"] else \"MISSING\"}')
        "
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        ENVIRONMENT: prod
        PULUMI_ORG: scoobyjava-org 