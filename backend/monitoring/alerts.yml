groups:
  - name: SophiaAILiveDataPipeline
    rules:
      # -----------------------------------------
      # Data Source & Pipeline Alerts
      # -----------------------------------------
      - alert: HighDataFetchErrorRate
        expr: sum(rate(sophia_data_fetch_errors_total[5m])) by (source) / sum(rate(sophia_data_fetch_duration_seconds_count[5m])) by (source) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate for data source: {{ $labels.source }}"
          description: "More than 10% of fetches from {{ $labels.source }} are failing over the last 5 minutes."

      - alert: HighDataFetchLatency
        expr: histogram_quantile(0.95, sum(rate(sophia_data_fetch_duration_seconds_bucket[5m])) by (le, source)) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High P95 latency for data source: {{ $labels.source }}"
          description: "The 95th percentile latency for fetching data from {{ $labels.source }} is over 5 seconds."

      - alert: StaleDataDetected
        expr: sophia_data_freshness_seconds > 3600 # 1 hour
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Stale data from source: {{ $labels.source }}"
          description: "Data from {{ $labels.source }} (type: {{ $labels.data_type }}) has not been updated in over an hour."

      - alert: LowCacheHitRate
        expr: sum(rate(sophia_cache_operations_total{operation="hit"}[5m])) by (cache_type) / sum(rate(sophia_cache_operations_total[5m])) by (cache_type) < 0.5
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "Low cache hit rate for {{ $labels.cache_type }}"
          description: "The cache hit rate for {{ $labels.cache_type }} is below 50%. Caching may be ineffective."

      # -----------------------------------------
      # LLM & AI Service Alerts
      # -----------------------------------------
      - alert: HighLLMErrorRate
        expr: sum(rate(llm_request_errors_total[5m])) by (provider, model) / sum(rate(llm_response_time_seconds_count[5m])) by (provider, model) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate for LLM provider: {{ $labels.provider }}"
          description: "More than 5% of requests to {{ $labels.provider }} (model: {{ $labels.model }}) are failing."

      - alert: HighLLMLatency
        expr: histogram_quantile(0.95, sum(rate(llm_response_time_seconds_bucket[5m])) by (le, provider, model)) > 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High P95 latency for LLM provider: {{ $labels.provider }}"
          description: "The 95th percentile latency for {{ $labels.provider }} (model: {{ $labels.model }}) is over 10 seconds."

      # -----------------------------------------
      # Data Quality Alerts
      # -----------------------------------------
      - alert: HighDataValidationFailureRate
        expr: rate(sophia_data_validation_failures_total[10m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Data validation failures detected for source: {{ $labels.source }}"
          description: "Invalid data is being ingested from {{ $labels.source }} (validation type: {{ $labels.validation_type }})."

      - alert: HighEmptyResultRate
        expr: sum(rate(sophia_empty_results_queries_total[10m])) by (source) / sum(rate(sophia_user_queries_total[10m])) by (source) > 0.5
        for: 30m
        labels:
          severity: info
        annotations:
          summary: "High rate of empty results from source: {{ $labels.source }}"
          description: "Over 50% of queries to {{ $labels.source }} are returning empty results. Check upstream data source."
