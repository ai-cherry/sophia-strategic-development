# Sophia AI Distributed Infrastructure - nginx Load Balancer
# Fixed configuration without unsupported directives

upstream sophia_ai_core {
    server 192.222.58.232:8001 weight=3 max_fails=3 fail_timeout=30s;
    server 192.222.58.232:8002 weight=2 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream sophia_business_tools {
    server 104.171.202.117:8110 weight=2 max_fails=3 fail_timeout=30s;
    server 104.171.202.117:8111 weight=2 max_fails=3 fail_timeout=30s;
    server 104.171.202.117:8112 weight=2 max_fails=3 fail_timeout=30s;
    server 104.171.202.117:8113 weight=2 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream sophia_data_pipeline {
    server 104.171.202.134:8210 weight=2 max_fails=3 fail_timeout=30s;
    server 104.171.202.134:8211 weight=2 max_fails=3 fail_timeout=30s;
    server 104.171.202.134:8212 weight=2 max_fails=3 fail_timeout=30s;
    server 104.171.202.134:8213 weight=2 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream sophia_development {
    server 155.248.194.183:8310 weight=1 max_fails=3 fail_timeout=30s;
    server 155.248.194.183:8311 weight=1 max_fails=3 fail_timeout=30s;
    server 155.248.194.183:8312 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 8;
}

upstream sophia_legacy_support {
    server 104.171.202.103:8410 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 4;
}

# Main server configuration
server {
    listen 80;
    listen [::]:80;
    server_name sophia-intel.ai *.sophia-intel.ai;
    
    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    # Load balancer health check endpoint
    location /health {
        access_log off;
        return 200 "Sophia AI Load Balancer - Healthy\n";
        add_header Content-Type text/plain;
    }
    
    # AI Core Services (High-memory vector operations)
    location /api/ai/ {
        proxy_pass http://sophia_ai_core;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        proxy_request_buffering off;
    }
    
    # Business Tools (CRM, Project Management)
    location /api/business/ {
        proxy_pass http://sophia_business_tools;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Data Pipeline Services
    location /api/data/ {
        proxy_pass http://sophia_data_pipeline;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Development Tools
    location /api/dev/ {
        proxy_pass http://sophia_development;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Legacy Support
    location /api/legacy/ {
        proxy_pass http://sophia_legacy_support;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # WebSocket support for real-time features
    location /ws/ {
        proxy_pass http://sophia_ai_core;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
    }
    
    # Default route to AI Core
    location / {
        proxy_pass http://sophia_ai_core;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Error pages
    error_page 502 503 504 /error.html;
    location = /error.html {
        root /var/www/html;
        internal;
    }
}
