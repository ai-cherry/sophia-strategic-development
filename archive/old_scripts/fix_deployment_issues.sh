#!/bin/bash
# Fix common Sophia AI deployment issues
# This script automatically fixes common deployment issues

echo "ðŸ”§ Fixing Sophia AI deployment issues..."

# Set environment variables
export DEPLOY_ENV="production"
export DEPLOY_TARGET="lambda-labs"
export DEPLOY_REGION="us-west-2"

# Step 1: Set up SSH connection to production server
echo "ðŸ”‘ Setting up SSH connection to production server..."
SSH_KEY="~/.ssh/lambda_labs_key"
PROD_SERVER="sophia-prod.payready.ai"
PROD_USER="deploy"

# Check if we can connect to the server
echo "ðŸ”Œ Checking SSH connection..."
if ssh -i $SSH_KEY -o ConnectTimeout=5 $PROD_USER@$PROD_SERVER "echo 'Connection successful'"; then
  echo "âœ… SSH connection successful"
else
  echo "âŒ SSH connection failed. Please check:"
  echo "  - SSH key exists at $SSH_KEY"
  echo "  - Server $PROD_SERVER is reachable"
  echo "  - User $PROD_USER has access to the server"
  echo "  - Firewall allows SSH connections"
  exit 1
fi

# Step 2: Fix environment variables
echo "ðŸ”§ Fixing environment variables..."
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && cp .env .env.backup"

# Load secrets from local .env file
if [ -f ".env" ]; then
  echo "ðŸ“¥ Loading secrets from local .env file..."
  source .env
else
  echo "âš ï¸ No local .env file found. Using placeholder values."
  # Set placeholder values
  ANTHROPIC_API_KEY="PLACEHOLDER_ANTHROPIC_API_KEY"
  PULUMI_ACCESS_TOKEN="PLACEHOLDER_PULUMI_ACCESS_TOKEN"
  SLACK_BOT_TOKEN="PLACEHOLDER_SLACK_BOT_TOKEN"
  SLACK_APP_TOKEN="PLACEHOLDER_SLACK_APP_TOKEN"
  SLACK_SIGNING_SECRET="PLACEHOLDER_SLACK_SIGNING_SECRET"
  SLACK_CLIENT_ID="PLACEHOLDER_SLACK_CLIENT_ID"
  SLACK_CLIENT_SECRET="PLACEHOLDER_SLACK_CLIENT_SECRET"
  SLACK_REFRESH_TOKEN="PLACEHOLDER_SLACK_REFRESH_TOKEN"
fi

ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && cat > .env << EOF
# Sophia AI Environment Variables
# Auto-generated by fix_deployment_issues.sh

# API Keys
ANTHROPIC_API_KEY=\${ANTHROPIC_API_KEY}
PULUMI_ACCESS_TOKEN=\${PULUMI_ACCESS_TOKEN}

# Slack Integration
SLACK_BOT_TOKEN=\${SLACK_BOT_TOKEN}
SLACK_APP_TOKEN=\${SLACK_APP_TOKEN}
SLACK_SIGNING_SECRET=\${SLACK_SIGNING_SECRET}
SLACK_CLIENT_ID=\${SLACK_CLIENT_ID}
SLACK_CLIENT_SECRET=\${SLACK_CLIENT_SECRET}
SLACK_REFRESH_TOKEN=\${SLACK_REFRESH_TOKEN}

# Linear Integration (placeholder)
LINEAR_API_TOKEN=lin_api_placeholder
LINEAR_WORKSPACE_ID=lin_workspace_placeholder

# Gong Integration (placeholder)
GONG_CLIENT_ID=gong_client_placeholder
GONG_CLIENT_SECRET=gong_secret_placeholder

# Database Configuration
DATABASE_URL=postgresql://sophia:sophia_password@localhost:5432/sophia
REDIS_URL=redis://localhost:6379/0

# Vector Database Configuration
PINECONE_API_KEY=pinecone_api_placeholder
PINECONE_ENVIRONMENT=us-west1-gcp
WEAVIATE_URL=http://localhost:8080
WEAVIATE_API_KEY=weaviate_api_placeholder

# Server Configuration
PORT=8000
NODE_ENV=production
LOG_LEVEL=info
EOF"
echo "âœ… Environment variables fixed"

# Step 3: Fix Docker Compose configuration
echo "ðŸ³ Fixing Docker Compose configuration..."
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && cp docker-compose.mcp.yml docker-compose.mcp.yml.backup"
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && sed -i 's/volumes:\\s*slack:\\s*depends_on:/volumes:\\n    slack:\\n  depends_on:/g' docker-compose.mcp.yml"
echo "âœ… Docker Compose configuration fixed"

# Step 4: Fix Python package dependencies
echo "ðŸ“¦ Fixing Python package dependencies..."
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && ./fix_dependencies.py"
echo "âœ… Python package dependencies fixed"

# Step 5: Fix SSL certificates
echo "ðŸ”’ Fixing SSL certificates..."
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && ./fix_ssl_certificates.py"
echo "âœ… SSL certificates fixed"

# Step 6: Restart Docker containers
echo "ðŸ”„ Restarting Docker containers..."
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && docker-compose -f docker-compose.mcp.yml down"
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && docker-compose -f docker-compose.mcp.yml up -d"
echo "âœ… Docker containers restarted"

# Step 7: Restart Nginx
echo "ðŸŒ Restarting Nginx..."
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "sudo systemctl restart nginx"
echo "âœ… Nginx restarted"

# Step 8: Restart Sophia service
echo "âš™ï¸ Restarting Sophia service..."
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "sudo systemctl restart sophia"
echo "âœ… Sophia service restarted"

# Step 9: Run health check
echo "ðŸ©º Running health check..."
ssh -i $SSH_KEY $PROD_USER@$PROD_SERVER "cd /opt/sophia && ./run_with_ssl_fix.py automated_health_check.py"
echo "âœ… Health check complete"

echo "âœ… Deployment issues fixed!"
echo "Please run ./diagnose_deployment.sh to verify that all issues have been resolved."
