
-- ==================================================
-- SOPHIA AI PHASE 1: CUSTOMER INSIGHTS FOUNDATION
-- ==================================================

-- Main customer insights database and schema
CREATE DATABASE IF NOT EXISTS SOPHIA_AI_CUSTOMER_INSIGHTS;
USE DATABASE SOPHIA_AI_CUSTOMER_INSIGHTS;
CREATE SCHEMA IF NOT EXISTS CUSTOMER_INTELLIGENCE;
USE SCHEMA CUSTOMER_INTELLIGENCE;

-- =================
-- CORE TABLES
-- =================

-- Customer profiles with AI enrichment
CREATE OR REPLACE TABLE CUSTOMER_PROFILES (
    customer_id VARCHAR(50) PRIMARY KEY,
    customer_name VARCHAR(255) NOT NULL,
    company VARCHAR(255),
    industry VARCHAR(100),
    customer_tier VARCHAR(20), -- Enterprise, SMB, Startup
    created_date TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    last_interaction_date TIMESTAMP_NTZ,
    total_revenue DECIMAL(15,2) DEFAULT 0,
    health_score DECIMAL(3,2), -- 0.0 to 1.0
    churn_risk_score DECIMAL(3,2), -- 0.0 to 1.0
    growth_potential_score DECIMAL(3,2), -- 0.0 to 1.0
    customer_embedding VECTOR(FLOAT, 768), -- AI customer representation
    profile_summary TEXT,
    ai_insights TEXT,
    created_by VARCHAR(100) DEFAULT 'sophia_ai',
    updated_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

-- Customer interactions across all touchpoints
CREATE OR REPLACE TABLE CUSTOMER_INTERACTIONS (
    interaction_id VARCHAR(50) PRIMARY KEY,
    customer_id VARCHAR(50) NOT NULL,
    interaction_type VARCHAR(50), -- call, email, meeting, support, demo
    interaction_date TIMESTAMP_NTZ NOT NULL,
    interaction_content TEXT,
    interaction_summary TEXT,
    sentiment_score DECIMAL(3,2), -- -1.0 to 1.0
    topics ARRAY,
    key_insights ARRAY,
    action_items ARRAY,
    deal_impact VARCHAR(20), -- positive, negative, neutral
    urgency_level VARCHAR(20), -- low, medium, high, critical
    interaction_embedding VECTOR(FLOAT, 768),
    source_system VARCHAR(50), -- gong, hubspot, slack, linear
    source_id VARCHAR(100),
    created_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    FOREIGN KEY (customer_id) REFERENCES CUSTOMER_PROFILES(customer_id)
);

-- Customer journey stages and progression
CREATE OR REPLACE TABLE CUSTOMER_JOURNEY (
    journey_id VARCHAR(50) PRIMARY KEY,
    customer_id VARCHAR(50) NOT NULL,
    journey_stage VARCHAR(50), -- prospect, demo, negotiation, closed_won, expansion, renewal, churn
    stage_entered_date TIMESTAMP_NTZ NOT NULL,
    stage_duration_days INTEGER,
    stage_success_probability DECIMAL(3,2),
    stage_blockers ARRAY,
    stage_accelerators ARRAY,
    next_best_action TEXT,
    ai_recommendations ARRAY,
    created_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    FOREIGN KEY (customer_id) REFERENCES CUSTOMER_PROFILES(customer_id)
);

-- =================
-- AI ENRICHMENT TABLES
-- =================

-- Customer insights generated by AI
CREATE OR REPLACE TABLE CUSTOMER_AI_INSIGHTS (
    insight_id VARCHAR(50) PRIMARY KEY,
    customer_id VARCHAR(50) NOT NULL,
    insight_type VARCHAR(50), -- behavior_pattern, growth_opportunity, risk_factor, recommendation
    insight_title VARCHAR(255),
    insight_description TEXT,
    confidence_score DECIMAL(3,2),
    impact_score DECIMAL(3,2), -- potential business impact
    evidence ARRAY, -- supporting data points
    recommended_actions ARRAY,
    created_date TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    expires_date TIMESTAMP_NTZ, -- when insight becomes stale
    status VARCHAR(20) DEFAULT 'active', -- active, acted_upon, expired
    FOREIGN KEY (customer_id) REFERENCES CUSTOMER_PROFILES(customer_id)
);

-- Predictive analytics for customers
CREATE OR REPLACE TABLE CUSTOMER_PREDICTIONS (
    prediction_id VARCHAR(50) PRIMARY KEY,
    customer_id VARCHAR(50) NOT NULL,
    prediction_type VARCHAR(50), -- churn_risk, expansion_opportunity, renewal_likelihood
    prediction_value DECIMAL(10,4),
    prediction_confidence DECIMAL(3,2),
    prediction_factors ARRAY,
    prediction_date TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    prediction_horizon_days INTEGER, -- how many days into future
    model_version VARCHAR(20),
    actuals_value DECIMAL(10,4), -- actual outcome when available
    prediction_accuracy DECIMAL(3,2), -- accuracy when actuals available
    FOREIGN KEY (customer_id) REFERENCES CUSTOMER_PROFILES(customer_id)
);

-- =================
-- PERFORMANCE TRACKING
-- =================

-- Customer success metrics
CREATE OR REPLACE TABLE CUSTOMER_SUCCESS_METRICS (
    metric_id VARCHAR(50) PRIMARY KEY,
    customer_id VARCHAR(50) NOT NULL,
    metric_date DATE NOT NULL,
    metric_type VARCHAR(50), -- usage, adoption, satisfaction, value_realization
    metric_value DECIMAL(15,4),
    metric_target DECIMAL(15,4),
    metric_variance_pct DECIMAL(5,2),
    trend_direction VARCHAR(10), -- up, down, stable
    benchmark_percentile INTEGER, -- vs other customers
    improvement_suggestions ARRAY,
    created_at TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    FOREIGN KEY (customer_id) REFERENCES CUSTOMER_PROFILES(customer_id)
);
